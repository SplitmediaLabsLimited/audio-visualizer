<!DOCTYPE html>
<html>
<head> 
<script type="text/javascript"> 

function canvasDrawLine(oPosX, oPosY, fPosX, fPosY) { 
    var ctx = getCanvas().getContext('2d'); 
    ctx.beginPath(); 
    ctx.moveTo(oPosX, oPosY); 
    ctx.lineTo(fPosX, fPosY); 
    ctx.stroke(); 
} 

function canvasDrawSquare(ulPosX, ulPosY, lrPosX, lrPosY) { 
    canvasDrawLine(ulPosX, ulPosY, ulPosX, lrPosY); 
    canvasDrawLine(ulPosX, lrPosY, lrPosX, lrPosY); 
    canvasDrawLine(lrPosX, lrPosY, lrPosX, ulPosY); 
    canvasDrawLine(lrPosX, ulPosY, ulPosX, ulPosY); 
}  

function canvasInitialize(width, height) { 
    // Set canvas parameters 
    getCanvas().width = width; 
    getCanvas().height = height; 

    // Outline 
    getCanvas().getContext('2d').clearRect(0,0,width,height); 
    canvasDrawSquare(0,0,width,height); 
} 

function getAverageVolume(array) { 
    var values = 0;  
    // get all the frequency amplitudes 
    for (var i = 0; i < array.length; i++) { 
        values += array[i]; 
    } 
    return values / (array.length); 
} 

function onSuccess(stream) { 
    var context = new AudioContext(); 
    var mediaStreamSource = context.createMediaStreamSource(stream); 
     
    var analyser = context.createAnalyser(); 
    analyser.smoothingTimeConstant = 0.3; 
    analyser.fftSize = 1024; 
     
    var javascriptNode = context.createScriptProcessor(2048, 1, 1); 
     
    javascriptNode.onaudioprocess = function(e) {
        //var sample = e.inputBuffer.getChannelData(0); 

        // get the average, bincount is fftsize / 2 
        var array =  new Uint8Array(analyser.frequencyBinCount); 
        analyser.getByteFrequencyData(array); 
        // calculate average 
        var average = getAverageVolume(array) 
         
        // print value out 
        console.log(average); 
         
        // draw green bar 
        getCanvas().getContext('2d').strokeStyle='#000000'; 
        canvasInitialize(200,200); 
        getCanvas().getContext('2d').strokeStyle='#00ff00'; 
        canvasDrawSquare(10, 150, 20, 150-average*5); 
    }; 
     
    // stream -> mediaSource -> analyser -> javascriptNode -> destination 
    mediaStreamSource.connect(analyser); 
    analyser.connect(javascriptNode); 
    javascriptNode.connect(context.destination); 
} 

function onError() { 
    console.log(arguments);
} 

function log(logVal) { 
    getLog().innerHTML = logVal + '\n<br>'; 
} 

function getCanvas() { 
    return document.getElementById('mycanvas'); 
}     
  
function getLog() { 
    return document.getElementById('mylog'); 
} 

function getXBCAudioDeviceId(audioSources) {

    return XBCAudioDeviceId;
}

function setXBCAudioDeviceAsSource() {
    let audioSource = this.value;
    console.log(audioSource);
    navigator.getUserMedia({
        video: false,
        audio: {deviceId : {
            exact: audioSource
        }}
    }, onSuccess, onError); 
}

function setSelectOptions(audioSources) {
    let selectAudio = document.getElementById('selectAudio');
    for (var i = audioSources.length - 1; i >= 0; i--) {
        if (audioSources[i].kind === 'audioinput') {
            let newOption = document.createElement('option');
            newOption.text = audioSources[i].label;
            newOption.value = audioSources[i].deviceId;
            if(audioSources[i].label.indexOf('XSplitBroadcaster (DirectShow)') === 0){
            	newOption.setAttribute('selected','selected')
            }
            selectAudio.appendChild(newOption);

        }
    }
}

function documentReady() {
    console.log("TAKTE");
    navigator.mediaDevices.enumerateDevices().then(setSelectOptions);
} 
</script>
<style>
    * {
        /*color: #EEE;*/
    }
</style>
</head> 

<body onload="documentReady();"> 
    <canvas id="mycanvas"></canvas> 
    <div id="mylog"></div> 
    <select id="selectAudio" onchange="setXBCAudioDeviceAsSource()">
        <option disabled hidden selected>Select Audio</option>
    </select>
</body> 
</html>