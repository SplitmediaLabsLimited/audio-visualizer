<!--
/**
 * Copyright (c) 2017 Split Media Labs, All rights reserved.
 * <licenseinfo@splitmedialabs.com>
 * 
 * You may only use this file subject to direct and explicit grant of rights by Split Media Labs,
 * either by written license agreement or written permission.
 * 
 * You may use this file in its original or modified form solely for the purpose, and subject to the terms,
 * stipulated by the license agreement or permission.
 * 
 * If you have not received this file in source code format directly from Split Media Labs,
 * then you have no right to use this file or any part hereof.
 * Please delete all traces of the file from your system and notify Split Media Labs immediately.
 */
-->
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title></title>
	<link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="./bower_components/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="./css/config.css">
	<link rel="stylesheet" href="./css/flexbox-grid.css">

	<script src="./bower_components/xjs-framework/dist/xjs.js"></script>
	<script src="./bower_components/jquery/dist/jquery.min.js"></script>
	
	<script src="./bower_components/ace/build/src/ace.js"></script>
	<script src="./bower_components/Sortable/jquery.binding.js"></script>
	<script src="./bower_components/Sortable/jquery.fn.sortable.js"></script>

	<script src="./js/config.js"></script>
	<script type="text/javascript">
	
	$(()=> {
		$('.spinner .btn:first-of-type').on('click', function(e) {
			let obj =  $(this).parent().parent().find('input');
			$(obj).val( parseInt($(obj).val(), 10) + 1);
			$(obj).change();
	  	});
	  	$('.spinner .btn:last-of-type').on('click', function(e) {
			let obj =  $(this).parent().parent().find('input');
			$(obj).val( parseInt($(obj).val(), 10) - 1);
			$(obj).change();
	  	});

	  	$('.tabs a').click((e)=>{
			e.preventDefault();
			$('.tabs a').removeClass('selected');
			$(e.currentTarget).addClass('selected');
			$('.tabContainer').hide()
			$($(e.currentTarget).attr('href')).show();
		});
	  	
	  	$('.tabContainer').hide();
	  	$($('.tabs .selected').attr('href')).show();

		
		
	});
	</script>
<script>require('xjs').ready();</script>
</head>
<body>
<div class="bs-component">
	<button id="refreshVisualizer" class="btn btn-primary btn-xs"><i class="fa fa-refresh"></i> Refresh Visualizer</button>
</div>
<div class="toolbox">
	<div class="rows">
		<div class="row">
			<div class="row__item"><div class="content">Select Skin:</div></div>
			<div class="row__item row__item--double text-left">
				<select name="skin" id="skin">
					<option value="bars">Bars</option>
					<option value="oscilloscope">Oscilloscope</option>
				</select>
			</div>
		</div>
		<div class="row">
			<div class="row__item"><div class="content">Audio Input to Map</div></div>
			<div class="row__item row__item--double ">
				<div class="content">
					<select name="audioDeviceId" id="audioDeviceId">
					</select>   
				</div>
			</div>
		</div>
		<div class="row">
			<div class="row__item"><div class="content">Frame rate:</div></div>
			<div class="row__item row__item--double">
				<div class="row" style="width: 100%">
					<row class="row__item">
						<select name="fps" id="fps">
							<option value="15">15fps</option>
							<option value="30">30fps</option>
							<option value="45">45fps</option>
							<option value="60">60fps</option>
						</select>
					</row>
					<div class="row__item row__item--double">
						<div class="content text-right">Bit Sample:</div>
					</div>
					<div class="row__item">
						<select name="bitsample" id="bitsample">
							<option value="32">32</option>
							<option value="64">64</option>
							<option value="128">128</option>
							<option value="256">256</option>
							<option value="512">512</option>
							<option value="1024">1024</option>
							<option value="2048">2048</option>
							<option value="2048">4096</option>
						</select>
					</div>
				</div>
			</div>
			

		</div>
		<div class="row">
		<div class="row__item"><div class="content">Display framerate</div></div>
			<div class="row__item row__item--double">
				<input type="checkbox" id="displayfps" />
			</div>
		</div>
		<div class="std">
			<div class="row">
				<div class="row__item text-right"><div class="content text-right">Stroke width</div></div>
				<div class="row__item row__item--double ">
					<div class="input-group spinner">
						<input type="text" class="form-control input-xs" id="strokeW" value="2">
						<div class="input-group-btn-vertical">
							<button class="btn btn-default" type="button"><i class="fa fa-caret-up"></i></button>
							<button class="btn btn-default" type="button"><i class="fa fa-caret-down"></i></button>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="row__item text-right"><div class="content text-right">Stroke segmentation</div></div>
				<div class="row__item row__item--double ">
					<div class="input-group spinner">
						<input type="text" class="form-control input-xs" id="strokeS1" value="1">
						<div class="input-group-btn-vertical">
							<button class="btn btn-default" type="button"><i class="fa fa-caret-up"></i></button>
							<button class="btn btn-default" type="button"><i class="fa fa-caret-down"></i></button>
						</div>
					</div>
				
					<div class="input-group spinner">
						<input type="text" class="form-control input-xs" id="strokeS2" value="1">
						<div class="input-group-btn-vertical">
							<button class="btn btn-default" type="button"><i class="fa fa-caret-up"></i></button>
							<button class="btn btn-default" type="button"><i class="fa fa-caret-down"></i></button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="custom">
			<fieldset>
				<legend>Custom Visualization</legend>
				<div class="row ">
					<div class="row__item forceNoMargin tabs">
							<a class="introDocs selected" href="#introDocs">Initial Documentation</a>
							<a class="codeView " href="#manageVisualizations">Manage Custom Visualizations</a>
					</div>
				</div>
				<div class="row">
					<div class="row__item forceNoMargin">
						<div class="tabContainer" id="introDocs" >
							<div class="documentation">
								<!-- documentation start -->
								<h3>Welcome to XSplit Broadcaster Audio Visualizer plugin.</h3>
<p>This plugin helps streamers to use complex graphics to be used by xsplit broadcaster to visualize audio. we have included two predeterminated graphics (bars and oscilloscope). however you can import your own javascript visualizations and add it to this plugin.</p>
<p>When you have custom visualizations, please read carefully the instructions  below in order to make your code to work. if you need more scope variables that  could be missing, please write to erro@splitmedialabs.com with the requested 
scope variable with details.</p>
<h3>Development Notes</h3>
<p>You can pass your code almost intact. few modifications are needed to make your  code to work. please read carefully this references notes in order to consider 
what to do to make your custom visualization code work properly.</p>
<h3>debugging your code</h3>
<p>please enable developer mode on xbc and debug in http://localhost:9222 
  (default port used for xbc to debug sources) and look for 
  'xsplit broadcaster audio visualizer' on the list of links. in that way you can 
  debug your code if there is any error or if the visualization doesn't work 
  properly</p>
<h3> strict mode</h3>
<p>note that strict mode is enforced from the start up. if you have a visualization
  that has bad notations or undefined calls, it will most likely throw you an error. </p>
<h3>scope variables</h3>
<p>xsplit broadcaste audiovisualizer plugin exposes a series of variables that allows you to interact with the resultant audio visualizing process. here is the structure of the scope we provide:</p>
<p>the variable XBC_avz is an object type variable that exposes the following attributes:</p>
<pre>
var XBC_avz = {
    canvas,
    visualizer,
    analyser,
    fftsize,
    stream,
    mediastreamsource,
    fps,
    displayfps
}
</pre>
<h3> XBC_avz.canvas and XBC_avz.visualizer</h3>
<p>the canvas object already exists on the visualization plugin: <em> &lt;canvas id=&quot;visualizer&quot;&gt;&lt;/canvas&gt;</em>  so you could use this to reference such dom object:<br>
</p>
<pre>var canvas = document.getelementbyid('visualizer');
var visualizer = canvas.getcontext('2d');</pre>

<p><br>or use the existing reference passed by XBC_avz (canvas &amp; visualizer):</p>
<pre>var canvas = XBC_avz.canvas; 
var visualizer = XBC_avz.visualizer;</pre>
<p><br>given the case that some visualizations scripts such three.js creates their own &lt;canvas&gt; object, you could hide the initial visualizer using a jquery sentence:</p>
<pre>$('#visualizer').hide()</pre>
<p><br>then process the new visualization. please make sure to do correct reference to the visualizer variable in your script.<br>
</p>
<h3>XBC_avz.analyser</h3>
<p>if you want to create an analyser for your audio stream, the answer is</p>
<pre>var analyser = window._audiocontext.createanalyser()</pre>
<p><br>or you can use</p>
<pre>var analyser = XBC_avz.analyser;</pre>
<p><br>if you want to set getbytefrequencydata or getbytetimedomaindata for the analyser 
  you have to set the frequencyarray as follows:
</p>
<pre>var frequencyarray = new uint8array(analyser.frequencybincount);</pre>
<h3>XBC_avz.fttsize</h3>
<p> the analyser uses the fttsize (bitsample) passed by the main configuration window.
  so if you want to use the configuration options, please use XBC_avz.fftsize to use 
its value against the analyzer:</p>
<pre>var analyser = XBC_avz.analyser;
analyzer.fttsize = XBC_avz.fttsize;</pre>
<h3>XBC_avz.stream</h3>
<p><br>the stream object is passed by the plugin when you select an audio source from the configuration panel of this plugin</p>
<h3>XBC_avz.mediastreamsource</h3>
<p>by default, this plugin already connects to the audio source, so you don not need 
to connect from the window object. if you want to connect methods and properties of the media stream source use <br>
  XBC_avz.mediastreamsource to call any method or property for your source. example:</p>
<pre>var mymediastreamsource = XBC_avz.mediastreamsource;
.
.
.
visualization code
.
.
.
mymediastreamsource.connect(analyser);</pre>
<h3>XBC_avz.fps and XBC_avz.displayfps</h3>
<p><br>by default this plugin provides a framerate control for the two default visualizers
  bars and oscilloscope, while on custom it is always set to 60fps. if you want to 
control your framerate you have to add the following code.</p>
<p> ## indicatons<br>
  1. use XBC_avz.fps to use the fps you set on the configuration dialog window, and use
  XBC_avz.displayfps to allow to see the framerate on screen.</p>
<p> 2. insert this code before the function that creates the draw:</p>
<pre>let fps = 0;
let lastrun;
let fpinterval,starttime,now,then,elapsed;
function showfps(){
self.visualizer.fillstyle = "red";
self.visualizer.font = "normal 16pt arial";
self.visualizer.filltext(math.floor(fps) + " fps", 10, 26);
}
fpsinterval = 1000 / self._defaults.fps;
then = date.now();
starttime = then;
</pre>
<p><br> 3. add this piece of code inside of your drawing function before your code that
  performs the drawing. please see this example</p>
<pre>var canvas = XBC_avz.canvas; 
var visualizer = XBC_avz.visualizer;
var analyser = XBC_avz.analyser;
analyzer.fttsize = XBC_avz.fttsize;

// ### start frameskip initialization code
let fps = 0;
let lastrun;
let fpinterval,starttime,now,then,elapsed;
function showfps(){
self.visualizer.fillstyle = "red";
self.visualizer.font = "normal 16pt arial";
self.visualizer.filltext(math.floor(fps) + " fps", 10, 26);
}
fpsinterval = 1000 / self._defaults.fps;
then = date.now();
starttime = then;
// end frameskip initialization code

var drawfunction = function(){
window._requestanimationframe = window.requestanimationframe(drawfunction);
..
..
setup initial visualization settings
..
..
// ### start frameskip code part 1
now = date.now();
elapsed = now - then;
if(elapsed > fpsinterval){
self.visualizer.clearrect(0, 0, self.canvas.width, self.canvas.height);
var delta = (new date().gettime() - lastrun)/1000;
lastrun = new date().gettime();
fps = 1/delta;
if(self._defaults.displayfps){
showfps()
}
then = now - (elapsed % fpsinterval);
// ## end frameskip code part 1</pre>
<p>&nbsp;</p>
<h2>extra programming considerations</h2>
<h3>window._audiocontext</h3>
<p>the audiocontext object is already stored in window._audiocontext, so if you want to extract 
  or set any method or property, there is no need you do not need to create a new audiocontext(). use 
  the existing reference. warning: creating new audiocontext() instances could result in breaking the script.</p>
<h3> requestanimationframe callbacks and id</h3>
<p>when you setup a requstanimationframe in your function please bind the id of the 
  request to <strong>window._requestanimationframe</strong>, so in case the plugin have to perform a 
  cancelation of the drawing the plugin can stop the execution of the drawing function <br>
  without breaking your visualization. this is an example on how to achieve this:</p>
<pre>var mymediastreamsource = XBC_avz.mediastreamsource;
var drawfunction = function(){
window._requestanimationframe = window.requestanimationframe(drawfunction);
.
.
.
animation code
.
.
.
}
drawfunction();
mymediastreamsource.connect(analyser);</pre>
<h3>including external required libraries into your code</h3>
<p><br>if your code needs external js libraries to make your animation work it is important to add the following on the header of your document:</p>
<pre>/**
XBCAVZ_START
@require https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js
XBCAVZ_END
 */</pre>
<p>&nbsp;</p>
 <ul>
   <li>you must define in your header a comment that includes XBCAVZ_START and XBCAVZ_END</li>
   <li>use per each script a @require tag with the url of the external js reference you want to link to this script. the program will render those scripts on the order given</li>
   <li>each url must have a @require tag. if you have multiple external required libraries, use a @require tag per line per url</li>
 </ul>
 <p>in that way we ensure to include your external dependencies.</p>
								<!-- documentation end -->
							</div>
						</div>
						<div class="tabContainer" id="manageVisualizations">
							<div class="bs-component manageAction">
								<button class="btn btn-primary btn-xs addLocal"><i class="fa fa-plus"></i> Add Local JS File</button> or <button class="addURL btn btn-primary btn-xs"><i class="fa fa-plus"></i> Add a Remote JS URL</button>
							</div>
							<fieldset id="addLocalVisual" class="subpanel" style="display: block !important">
								<legend>Add Local JS Visualization File</legend>
								<input type="file" id="mylocalfile">
								<script type="text/javascript">
									$('#mylocalfile').on('change',(e)=>{
										debugger;
										//resolve the fakepath, so we can read the file as needed
										console.log(e)
									})
								</script>
								<button class="btn btn-primary btn-xs cancelAction"><i class="fa fa-times"></i> Cancel</button>
							</fieldset>
							<fieldset id="addURLVisual" class="subpanel">
								<legend>Add Remote JS Visualization File</legend>
								<div class="">
									<div class="row">
										<div class="row__item">Please write the name for this visualization</div>
									</div>
									<div class="row">
										<div class="row__item" style="display:flex"><input type="text" id="scriptName" class="form-control"/></div>
									</div>
									<div class="row">
										<div class="row__item">Please paste the URL where your script is located</div>
									</div>
									<div class="row">
										<div class="row__item--triple"  style="display:flex"><input type="text" id="urlscript" class="form-control"/></div>
										<div class="row__item"><div class="" style="width:100%;display: block; margin: auto 0"><button class="btn btn-primary btn-xs addRemoteSource"><i class="fa fa-plus"></i> Process URL</button></div> <button class="btn btn-primary btn-xs cancelAction"><i class="fa fa-times"></i> Cancel</button></div>
									</div>
								</div>

							</fieldset>
                            <fieldset id="manageVisuals">
                            	<legend>Manage Visualizations</legend>
                            	<div class="empty">No extra visualizations are available at the moment.</div>
                            	<ul id="list"></ul>
                            </fieldset>
						</div>
					</div>
				</div>
			</fieldset>
		</div>
	</div>
</div>
</body>
</html>